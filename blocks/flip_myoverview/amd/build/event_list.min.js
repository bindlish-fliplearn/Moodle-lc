define(["jquery","core/notification","core/templates","core/custom_interaction_events","block_flip_myoverview/calendar_events_repository"],function(t,n,e,a,i){var r='[data-region="empty-message"]',d='[data-region="event-list"]',o='[data-region="event-list-content"]',s='[data-region="event-list-group-container"]',l='[data-region="loading-icon-container"]',u='[data-action="view-more"]',c="block_flip_myoverview/event-list-items",f="block_flip_myoverview/event-list-items",v=function(t){t.attr("data-loaded-all",!0)},h=function(t){t.find(o).addClass("hidden"),t.find(r).removeClass("hidden")},m=function(n,a){var i=0,r=c;return n.attr("data-course-id")&&(r=f),t.when.apply(t,t.map(n.find(s),function(o){var s=a.filter(function(n,e){return function(a){return function(t,n,e){var a=t.attr("data-midnight"),i=86400*+e.attr("data-start-day"),r=86400*+e.attr("data-end-day"),d=function(t,n){return(n.timesort||0)-t}(a,n);return""===e.attr("data-end-day")?i<=d:i<=d&&d<r}(n,a,t(e))}}(n,o));return s.length?(i+=s.length,function(t,n,a){return t.removeClass("hidden"),e.render(a,{events:n}).done(function(n,a){e.appendNodeContents(t.find(d),n,a)})}(t(o),s,r)):null})).then(function(){return i})},g=function(e,a){var r=+(e=t(e)).attr("data-limit"),d=+e.attr("data-course-id"),o=e.attr("data-last-id"),s=e.attr("data-midnight")-1209600;if(function(t){return t.hasClass("loading")}(e))return t.Deferred().resolve();if(function(t){var n=t.find(l),e=t.find(u);t.addClass("loading"),n.removeClass("hidden"),e.prop("disabled",!0)}(e),void 0===a){var c={starttime:s,limit:r};o&&(c.aftereventid=o),a=d?i.queryByCompletedEvent(c):i.queryByTime(c)}return a.then(function(t){if(!t.events.length)return v(e),0;var n=t.events;return e.attr("data-last-id",n[n.length-1].id),n.length<r&&v(e),m(e,n).then(function(t){return t<n.length&&v(e),n.length})}).then(function(t){return function(t,n){n?function(t){t.attr("data-has-events",!0)}(t):function(t){return!!t.attr("data-has-events")}(t)||h(t)}(e,t)}).fail(n.exception).always(function(){!function(t){var n=t.find(l),e=t.find(u);t.removeClass("loading"),n.addClass("hidden"),function(t){return!!t.attr("data-loaded-all")}(t)?e.addClass("hidden"):e.prop("disabled",!1)}(e)})},p=function(t){a.define(t,[a.events.activate]),t.on(a.events.activate,u,function(){g(t)})};return{init:function(n){n=t(n),g(n),p(n)},registerEventListeners:p,load:g,rootSelector:'[data-region="event-list-container"]'}});