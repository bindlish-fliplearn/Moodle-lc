define(["jquery","core/notification","core/templates","core/custom_interaction_events","block_flip_myoverview/calendar_events_repository"],function(o,s,d,n,l){function u(t){t.attr("data-loaded-all",!0)}function c(n,e){return function(t){return function(t,n,e){var a=t.attr("data-midnight"),i=+e.attr("data-start-day")*v,r=+e.attr("data-end-day")*v,d=function(t,n){return(n.timesort||0)-t}(a,n);return""===e.attr("data-end-day")?i<=d:i<=d&&d<r}(n,t,o(e))}}function f(e,a){var i=0,r=p;return e.attr("data-course-id")&&(r=y),o.when.apply(o,o.map(e.find(t),function(t){var n=a.filter(c(e,t));return n.length?(i+=n.length,function(e,t,n){return e.removeClass("hidden"),d.render(n,{events:t}).done(function(t,n){d.appendNodeContents(e.find(h),t,n)})}(o(t),n,r)):null})).then(function(){return i})}function e(e,t){var a=+(e=o(e)).attr("data-limit"),n=+e.attr("data-course-id"),i=e.attr("data-last-id"),r=e.attr("data-midnight")-14*v;if(function(t){return t.hasClass("loading")}(e))return o.Deferred().resolve();if(function(t){var n=t.find(m),e=t.find(g);t.addClass("loading"),n.removeClass("hidden"),e.prop("disabled",!0)}(e),void 0===t){var d={starttime:r,limit:a};i&&(d.aftereventid=i),t=n?l.queryByCompletedEvent(d):l.queryByTime(d)}return t.then(function(t){if(!t.events.length)return u(e),0;var n=t.events;return e.attr("data-last-id",n[n.length-1].id),n.length<a&&u(e),f(e,n).then(function(t){return t<n.length&&u(e),n.length})}).then(function(t){return function(t,n){n?function(t){t.attr("data-has-events",!0)}(t):function(t){return!!t.attr("data-has-events")}(t)||C(t)}(e,t)}).fail(s.exception).always(function(){!function(t){var n=t.find(m),e=t.find(g);t.removeClass("loading"),n.addClass("hidden"),!function(t){return!!t.attr("data-loaded-all")}(t)?e.prop("disabled",!1):e.addClass("hidden")}(e)})}function a(t){n.define(t,[n.events.activate]),t.on(n.events.activate,g,function(){e(t)})}var v=86400,i='[data-region="empty-message"]',h='[data-region="event-list"]',r='[data-region="event-list-content"]',t='[data-region="event-list-group-container"]',m='[data-region="loading-icon-container"]',g='[data-action="view-more"]',p="block_flip_myoverview/event-list-items",y="block_flip_myoverview/course-event-list-items",C=function(t){t.find(r).addClass("hidden"),t.find(i).removeClass("hidden")};return{init:function(t){t=o(t),e(t),a(t)},registerEventListeners:a,load:e,rootSelector:'[data-region="event-list-container"]'}});